      PROGRAM BOOKS
      INTEGER          I
      CHARACTER(LEN=4) FNAME
      COMMON /MAIN/ FNAME
      FNAME = 'BOOK'
      
   10 DO
      PRINT*
      PRINT*
      PRINT*,'     CHOOSE OPTION:'
      PRINT*,'       1 - ADD NEW BOOK'
      PRINT*,'       2 - DELETE A BOOK'
      PRINT*,'       3 - MODIFY A BOOK'
      PRINT*,'       4 - SEARCH FOR BOOKS'
      PRINT*,'       5 - EXIT'
      READ(UNIT=*,FMT='(I1)',ERR=10) I
      IF(I .EQ. 1) CALL ADD
      IF(I .EQ. 2) CALL DELETE
      IF(I .EQ. 3) CALL MODIFY
      IF(I .EQ. 4) CALL SEARCH
      IF(I .EQ. 5) GOTO 20
      ENDDO
   20 CONTINUE
      STOP
      END

      SUBROUTINE ADD
      IMPLICIT NONE
      INTEGER           IDENT, YEAR, I, IERR
      CHARACTER(LEN=60) TITLE
      CHARACTER(LEN=20) AUTHOR
      
      PRINT*
      PRINT*
      PRINT*,'(ADDING NEW BOOK...)'
   30 PRINT*,'     FILL THE FORM:'
      PRINT*,'       + TITLE:'
      READ(UNIT=*,FMT='(A60)',ERR=30) TITLE
      PRINT*,'       + AUTHOR:'
      READ(UNIT=*,FMT='(A20)',ERR=30) AUTHOR
      PRINT*,'       + YEAR:'
      READ(UNIT=*,FMT='(I4)',ERR=30) YEAR
      
      CALL ADDBOOK(IDENT, TITLE, AUTHOR, YEAR, IERR)
      
      IF(IERR .NE. 0) PRINT*,'ERROR: ',IERR
      RETURN
      END
      
      SUBROUTINE DELETE
      IMPLICIT NONE
      INTEGER           IDENT, YEAR, I, IERR
      CHARACTER(LEN=60) TITLE
      CHARACTER(LEN=20) AUTHOR
      
      PRINT*
      PRINT*
      PRINT*,'(DELETING A BOOK...)'
   40 PRINT*,'     DELETE:'
      PRINT*,'       + TITLE:'
      READ(UNIT=*,FMT='(A60)',ERR=40) TITLE
      
      CALL DELBOOK(IDENT, TITLE, '', 2009, IERR)
      
      IF(IERR .NE. 0) PRINT*,'ERROR: ',IERR
      RETURN
      END
      
      SUBROUTINE MODIFY
      
      RETURN
      END
      
      SUBROUTINE SEARCH
      IMPLICIT NONE
      INTEGER           IDENT, YEAR, I, IERR
      CHARACTER(LEN=60) TITLE
      CHARACTER(LEN=20) AUTHOR
      
      PRINT*
      PRINT*
      PRINT*,'(SEARCHING A BOOK...)'
   50 PRINT*,'     SEARCH:'
      PRINT*,'       + TITLE:'
      READ(UNIT=*,FMT='(A60)',ERR=50) TITLE
      PRINT*,'       + AUTHOR:'
      READ(UNIT=*,FMT='(A20)',ERR=50) AUTHOR
      PRINT*,'       + YEAR:'
      READ(UNIT=*,FMT='(I4)',ERR=50) YEAR
      
      CALL FINDBOOK(IDENT, TITLE, AUTHOR, YEAR, IERR)
      
      IF(IERR .NE. 0) PRINT*,'ERROR: ',IERR
      RETURN
      END
      
C BOOK STUCTURE:
C --- IDENT
C --- TITLE
C --- AUTHOR
C --- YEAR

      SUBROUTINE FINDBOOK(IDENT, TITLE, AUTHOR, YEAR, IERR)
      IMPLICIT NONE
      INTEGER           IDENT, YEAR, I, Y, IERR
      CHARACTER(LEN=60) TITLE, T
      CHARACTER(LEN=20) AUTHOR, A
      CHARACTER(LEN=4)  FNAME
      INTEGER           FSTAT
      COMMON /MAIN/ FNAME
      IERR = 0
      IDENT = -1
      OPEN(UNIT=50,FILE=FNAME,STATUS='OLD',IOSTAT=FSTAT,ERR=100)
      DO WHILE(IDENT .EQ. -1)
        READ(UNIT=50,FMT=110,IOSTAT=FSTAT,ERR=100) I,T,A,Y
        IF(T .EQ. TITLE) IDENT = I
        IF(A .EQ. AUTHOR) IDENT = I
        IF(Y .EQ. YEAR) IDENT = I
      ENDDO
      CLOSE(UNIT=50,IOSTAT=FSTAT)
      RETURN
  100 IERR = FSTAT
      RETURN
  110 FORMAT(I4,A60,A20,I4)
      END

      SUBROUTINE ADDBOOK(IDENT, TITLE, AUTHOR, YEAR, IERR)
      IMPLICIT NONE
      INTEGER           IDENT, YEAR, I, Y, IERR
      CHARACTER(LEN=60) TITLE, T
      CHARACTER(LEN=20) AUTHOR, A
      CHARACTER(LEN=4)  FNAME
      INTEGER           FSTAT
      COMMON /MAIN/ FNAME
      IERR = 0
      IDENT = 0
      FSTAT = -100
      I = 0
      OPEN(UNIT=50,FILE=FNAME,STATUS='OLD',IOSTAT=FSTAT,ERR=200)

      DO WHILE(FSTAT .GE. 0)
        READ(UNIT=50,FMT=210,IOSTAT=FSTAT,END=195) I,T,A,Y
        IF(I .GT. 0) THEN
          IDENT = I
        ELSE
          IDENT = IDENT + 1
        ENDIF
        IF((T .EQ. TITLE) .AND. (.NOT. (I .EQ. 0))) GOTO 200 ! BOOK WITH THIS TITLE ALREADY EXISTS
      ENDDO
  195 BACKSPACE(UNIT=50,IOSTAT=FSTAT,ERR=200)
      IDENT = IDENT + 1
      WRITE(UNIT=50,FMT=210,IOSTAT=FSTAT,ERR=200) IDENT,
     +                TITLE, AUTHOR, YEAR 
     
      CLOSE(UNIT=50,IOSTAT=FSTAT,ERR=200)
      
      RETURN
  200 IERR = FSTAT
  205 RETURN
  210 FORMAT(I4,A60,A20,I4)
      END
      
      SUBROUTINE DELBOOK(IDENT, TITLE, AUTHOR, YEAR, IERR)
      IMPLICIT NONE
      INTEGER           IDENT, YEAR, I, Y, IERR
      CHARACTER(LEN=60) TITLE, T
      CHARACTER(LEN=20) AUTHOR, A
      CHARACTER(LEN=4)  FNAME
      INTEGER           FSTAT
      COMMON /MAIN/ FNAME
      IERR = 0
      IDENT = -1
      FSTAT = -100
      
      OPEN(UNIT=50,FILE=FNAME,STATUS='OLD',IOSTAT=FSTAT,ERR=300)
      
      DO WHILE(IDENT .LE. 0)
        READ(UNIT=50,FMT=310,IOSTAT=FSTAT,ERR=300) I,T,A,Y
        IF(T .EQ. TITLE) IDENT = I
      ENDDO
      BACKSPACE(UNIT=50,IOSTAT=FSTAT,ERR=300)
      I = 0
      WRITE(UNIT=50,FMT=310,IOSTAT=FSTAT,ERR=300) I,T,A,Y
      
      CLOSE(UNIT=50,IOSTAT=FSTAT,ERR=300)
      
      RETURN
  300 IERR = FSTAT
  305 RETURN
  310 FORMAT(I4,A60,A20,I4)
      END
      
      SUBROUTINE MODBOOK(IDENT, TITLE1, AUTHOR1, YEAR1,
     +                          TITLE2, AUTHOR2, YEAR2, IERR)
      IMPLICIT NONE
      INTEGER           IDENT, YEAR1, YEAR2, I, Y, IERR
      CHARACTER(LEN=60) TITLE1, TITLE2, T
      CHARACTER(LEN=20) AUTHOR1, AUTHOR2, A
      CHARACTER(LEN=4)  FNAME
      INTEGER           FSTAT
      COMMON /MAIN/ FNAME
      IERR = 0
      IDENT = -1
      FSTAT = -100
      
      CALL FINDBOOK(IDENT, TITLE1, AUTHOR1, YEAR1, IERR)
      IF(IERR .GT. 0) GOTO 405
      IF(IDENT .LT. 1) GOTO 400 !BOOK DOES NOT EXIST
      
      OPEN(UNIT=50,FILE=FNAME,STATUS='OLD',IOSTAT=FSTAT,ERR=400)
      
      READ(UNIT=50,FMT=410,IOSTAT=FSTAT,ERR=400) I,T,A,Y
      DO WHILE(I .NE. IDENT)
      READ(UNIT=50,FMT=410,IOSTAT=FSTAT,ERR=400,END=395) 
     +                I, T, A, Y
      ENDDO
      BACKSPACE(UNIT=50,IOSTAT=FSTAT,ERR=400)
  395 WRITE(UNIT=50,FMT=410,IOSTAT=FSTAT,ERR=400) I,
     +                TITLE2, AUTHOR2, YEAR2 
     
      CLOSE(UNIT=50,IOSTAT=FSTAT,ERR=400)
      
      RETURN
  400 IERR = FSTAT
  405 RETURN
  410 FORMAT(I4,A60,A20,I4)
      END
