C     MILTIPLE DECAY ANALYSIS PROGRAM
      DIMENSION ARRAY(20,20),PHI(400),TAU(400),WT(400),COL(20),
     1ANS(20),UNIT(21),A(10),B(10),OUT(60),NOUT(60),RESID(400),
     2CALC(400),WTRES(400)
C      SENSE LIGHT 0
 100  WRITE(UNIT=6,FMT=10)
 10   FORMAT(46H   UNFOLDING SOLUTION OF MULTIPLE DECAY DATA  )
C     INPUT REGINS
      READ(UNIT=5,FMT=20)
 20   FORMAT(72H    DATA OF 3/18/60. (TIMES MEASURED IN MINUTES)
     1                 )
      READ(UNIT=5,FMT=30) N,M,NC,NE
 30   FORMAT(22H   NO. OF COMPONENTS= ,I2,21H, NO. OF DATA POINTS= ,I3,
     123H, NO. FIXED COMPONENTS=,I1,/,25H NO. OF FIXED HALF LIVES=,I1)
      READ (UNIT=5,FMT=40) (TAU(I),PHI(I),WT(I),I=1,M)
 40   FORMAT(6H TIME=,F8.3,9H   COUNT=,F8.3,10H   WEIGHT=,F8.3)
      READ (UNIT=5,FMT=50) (A(I),B(I),I=1,N)
 50   FORMAT(9H       A=,F8.3,5H   B=,F8.3)
      READ(UNIT=5,FMT=60) CONV, WIFACT
 60   FORMAT(27H   CONVERGENCE REQUIREMENT=,F8.3,15H WEIGHT FACTOR=,
     1F10.5)
      WRITE(UNIT=6,FMT=20)
      WRITE(UNIT=6,FMT=30) N,M,NC,NE
C     COMPUTATION BEGINS, COMPUTE WEIGHTS
      DO 140 I=1,M
      WT(I)=WT(I)*WIFACT
      IF(WT(I)) 110,120,130
 110  WT(I)=-WT(I)
      GO TO 140
 120  WT(I)=WFACT/PHI(I)
      GO TO 140
 130  WT(I)=WT(I)/PHI(I)**2
 140  CONTINUE
      DO 150 I=1,N
 150  B(I)=-0.69315/B(I)
C     GENERATE INDICES
      NJJ=2*N
      NPNC=N
      N=N-NC
      NPO=N+1
      NJ=2*N-NE
      NI=2*N+1
      NL=N-NE
      NK=NL+1
C     INTERMEDIATE OUTPUT
      WRITE(UNIT=6,FMT=65) (I,I=1,NPNC)
 65   FORMAT(40H0         TRIAL VALUES OF A(I) AND B(I)  ,/,
     1 7H0   I= ,I5,9I11)
 250  DO 255 I=1,NPNC
      J=i+NPNC
      OUT(I)=A(I)
 255  OUT(J)=-0.69315/B(I)
      DO 260 I=1,NJJ
      CALL TEFOUT(OUT(I),NOUT(I))
 260  CONTINUE
      WRITE(UNIT=6,FMT=70) (OUT(I),NOUT(I),I=1,NPNC)
 70   FORMAT(6H0A(I)= ,10(F8.3,I3))
      I1=NPNC+1
      WRITE(UNIT=6,FMT=75) (OUT(I),NOUT(I),I=I1,NJJ)
 75   FORMAT(6H B(I)= ,10(F8.3,I3))
C     COMPUTATION PROCEEDS, CALCULATE PSI(I)
 160  DO 170 I=1,NJ
      COL(I)=0.0
      DO 170 J=1,NJ
 170  ARRAY(I,J)=0.0
      DO 200 J=1,M
      DO 180 K=1,NJ
 180  UNIT(K)=0.0
      UNIT(NI)=PHI(J)
      DO 190 I=1,N
      Y=B(I)*TAU(J)
      IF(25.0+Y) 183,186,186
 183  BOLD=0.0
      GO TO 190
 186  BOLD=EXP(Y)
      UNIT(I)=A(I)*BOLD
      K=I+N
      UNIT(K)=-A(I)*B(I)*TAU(J)*BOLD
 190  UNIT(NI)=UNIT(NI)-UNIT(I)
C     CORRECTION FOR FIXED COMPONENTS
      IF(NC) 191,191,1910
 1910 DO 1930 I=NPO,NPNC
      Y=B(I)*TAU(J)
      IF(25.0+Y) 1930,1920,1920
 1920 UNIT(NI)=UNIT(NI)-A(I)*EXP(Y)
 1930 CONTINUE
C     SET UP MATRIX AND COLUMN VECTOR
 191  DO 200 L=1,NJ
      DO 199 K=1,NJ
 199  ARRAY(K,L)=ARRAY(K,L)+WT(J)*UNIT(K)*UNIT(L)
 200  COL(L)=COL(L)+UNIT(L)*UNIT(NI)*WT(J)
C     INVERT MATRIX
 211  CALL MATINV(ARRAY,NJ)!====================================
*      IF(SENSE LIGHT 1) 212, 213
* 212  WRITE (UNIT=6,FMT=2120)
* 2120 FORMAT(20H0 RESTART BYMATINV  )
*      GO TO 100
C     COMPUTE CORRECTION TERMS
 213  DO 220 I=1,NJ
      ANS(I)=0.0
      DO 220 J=1,NJ
C     CORRECT EXPONENTS
 220  ANS(I)=ANS(I)+ARRAY(I,J)*COL(J)
      IF(NL) 226,226,221
 221  DO 225 I=1,NL
      I1=I+N
 225  B(I)=B(I)*(1.0-ANS(I1))
 226  XMAX=0.0
C     CORRECT COEFFICIENTS
      DO 230 I=1,N
      A(I)=A(I)*(1.0+ANS(I))
 230  XMAX=MAX(XMAX,ABS(ANS(I)))
C     CONVERGENCE TEST
      IF(XMAX-CONV) 240,240,250
C     COMPUTE CALCUALETED VALUES
 240  DO 245 I=1,M
      CALC(I)=0.0
      DO 245 J=1,NPNC
 245  CALC(I)=CALC(I)+A(J)*EXP(B(J)*TAU(I))
      SQRES=0.0
C     COMPUTE PERCENTAGE SEVIATION AND WEIGHTED SQUARED RESIDUALS
      DO 246 I=1,M
      RESID(I)=(CALC(I)-PHI(I))/PHI(I)
      WTRES(I)=WT(I)*(RESID(I)*PHI(I))**2
 246  SQRES=SQRES+WTRES(I)
C     COMPUTE WEIGHTED VARIANCE
      WVAR=SQRES/FLOAT(M-NJ-1)
C     OUTPUT BEGINS, DEFINE OUTPUT QUANTITIES
 280  DO 281 I=1,N
      J=6*I-5
      OUT(J)=A(I)
      OUT(J+1)=-0.69315/B(I)
      OUT(J+2)=ANS(I)
 281  OUT(J+4)=A(I)*SQRT(ARRAY(I,1)*WVAR)
C     BRANCH IF ALL FIXED EXPONENTS
      IF (NL) 282,282,284
 282  DO 283 I=1,N
      J=6*I-5
      OUT(J+3)=0.0
 283  OUT(J+5)=0.0
      GO TO 291
 284  DO 285 I=1,NL
      J=6*I-5
      II=I+N
      OUT(J+3)=-ANS(II)
 285  OUT(J+5)=(-0.69315/B(I))*SQRT(ARRAY(II,II)*WVAR)
C     BRANCH IF ANY FIXED EXPONENT
      IF (NE) 291,291,286
 286  DO 290 I=NK,N
      J=6*I-5
      OUT(J+3)=0.0
 290  OUT(J+5)=0.0
 291  J=6*N
C     OUTPUT COEFFICIENTS AND ERRORS
      DO 300 I=1,J
      CALL TEFOUT(OUT(I),NOUT(I))
 300  CONTINUE
      WRITE(UNIT=6,FMT=90) (OUT(I),NOUT(I),I=1,J)
 90   FORMAT(24H1 FINAL VALUES OBTAINED ,//,94H      A            B
     1       ALPHA         BETA          SIGMA(A)        SIGMA(B)
     2    ,//,(6(F11.4, I3)))
C     BRANCH IF ANY FIXED COMPONENTS
      IF(NC) 355,355,340
 340  DO 350 I=NPO, NPNC
      OUT(1)=A(1)
      CALL TEFOUT(OUT(1),NOUT(1))
      OUT(2)=-0.69315/B(I)
      CALL TEFOUT(OUT(2),NOUT(2))
      WRITE(UNIT=6,FMT=95) OUT(1),NOUT(1),OUT(2),NOUT(2)
 95   FORMAT(2(F11.4, I3))
 350  CONTINUE
C     OUTPUT WEIGHTED VARIANCE AND WEIGHTED SQUARED RESIDUALS
 355  OUT(1)=WVAR
      CALL TEFOUT(OUT(1),NOUT(1))
      OUT(2)=SQRES
      CALL TEFOUT(OUT(2),NOUT(2))
      WRITE(UNIT=6,FMT=975) OUT(1),NOUT(1),OUT(2),NOUT(2)
 975  FORMAT(19H0WEIGHTED VARIANCE=,F11.4,I3,40H   SUM OF WEIGHTED
     1SQUARED RESIDUALS=,F11.4, I3)
C     OUTPUT DATA POINT QUANTITIES
 360  WRITE(UNIT=6,FMT=400)
 400  FORMAT(114H0    TIME        OBSERVED RATE      WEIGHT USED       C
     1ALCULATED RATE      PER CENT DEVIATION    WT SQ RESIDUALS  / 2H  )
      DO 330 I=1,M
      OUT(1)=TAU(I)
      OUT(2)=PHI(I)
      OUT(3)=WT(I)
      OUT(4)=CALC(I)
      OUT(5)=100.0*RESID(I)
      OUT(6)=WTRES(I)
      DO 320 J=1,6
      CALL TEFOUT(OUT(J),NOUT(J))
 320  CONTINUE
 330  WRITE (UNIT=5,FMT=410)(OUT(J),NOUT(J),J=1,6)
 410  FORMAT(F9.4,I3,F13.4,I3,F15.4,I3,F16.4,I3,F21.4,I3,F17.4,I3)
      GO TO 100
      STOP
      END

C     THIS SUBROUTINE INVERTS A SQUARE MATRIX WITH SIDE M IN SIZE
      SUBROUTINE MATINV(X,M)
      DIMENSION X(20,20), K(20)
*      FREQUENCY 105(1,0,1),125(5,1,5),155(1,0,1),160(1,0,0),175(1,0,
*     11), 230(1,2,1)
C     TEST FOR MATRIX SIZE
      IF (M-1) 190,20,30
 20   X(1,1)=1.0/X(1,1)
      GO TO 245
C     INITIALIZE ROUTINE CONSTANTS
 30   TEST=0.0
      MM=M-1
      DO 100 I=1,M
 100  K(J)=I
      DO 150 N=1,M
C     TEST PIVOTAL ELEMENT
 105  IF(X(1,N)) 110,160,110
C     MATRIX INVERSION BY ONE COLUMN
 110  A=X(1,N)
      DO 120 I=1,MM
 120  X(I,N)=X(I+1,N)/A
      X(M,N)=1.0/A
      DO 150 J=1,M
 125  IF(J-N) 130,150,130
 130  A=X(1,J)
      DO 140 I=1,MM
 140  X(I,J)=X(I+1,J)-A*X(I,N)
      X(M,J)=-A*X(M,N)
 150  CONTINUE
C     SEARCH FOR ROW WITH NON-ZERO ELEMENT IN FIRST COLUMN
 155  IF(TEST) 220,245,220
 160  IF(N-M) 170,190,190
 170  NN=N+1
      DO 180 L=NN,M
 175  IF(X(1,l)) 200,180,200
 180  CONTINUE
C     SENSE LIGHT EXIT IF MATRIX HAS NO INVERSE
* 190  SENSE LIGHT 1
  190 CONTINUE
      GO TO 245
C     REORDER MATRIX TO OBTAIN NON-ZERO PIVOTAL ELEMENT
 200  DO 210 I=1,M
      HOLD=X(I,N)
      X(I,N)=X(I,L)
 210  X(I,L)=HOLD
      LL=K(N)
      K(N)=K(L)
      K(L)=LL
      TEST=1.0
      GO TO 110
C     UNSRAMBLE REORDERED MATRIX TO OBTAIL CORRECT INVERSE
 220  DO 240 I=1,MM
 230  IF(K(I)-I) 250,240,250
 240  CONTINUE
 245  RETURN
 250  L=K(I)
      DO 260 J=1,M
      HOLD=X(I,J)
      X(I,J)=X(L,J)
 260  X(L,J)=HOLD
      K(I)=K(L)
      K(L)=L
      GO TO 230
      RETURN
      END

      SUBROUTINE TEFOUT(X,I)
      IF(X) 2,1,2
 1    I=0
      RETURN
 2    A=40.0+(0.43429448*LOG(ABS(X)))
      X=SIGN(EXP(MOD(A,1.0)/0.43429448),X)
      I=INT(A)-40
      RETURN
      END
